# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

hyprlog is a structured logging library for the Hypr ecosystem, written in Rust (edition 2024, MSRV 1.85). It provides a CLI tool, a Rust library, C-ABI FFI bindings, and optional Hyprland IPC integration. Config files use TOML and live at `~/.config/hypr/hyprlog.conf`.

## Build & Development Commands

The project uses `just` as task runner (all commands delegate to scripts in `dev/scripts/`):

```bash
just build              # Release build (cargo build --workspace --release)
just build-debug        # Debug build
just test               # Run tests via cargo-nextest (falls back to cargo test)
just fmt                # Format code (cargo fmt --all)
just fmt --check        # Check formatting without modifying
just lint               # Clippy with -D warnings
just lint --strict      # Clippy with pedantic + nursery
just pre-commit         # Pre-commit checks
just docs               # Generate and open rustdoc
just bench              # Run criterion benchmarks (cargo bench)
just fuzz               # Run all fuzz targets (30s each, requires cargo-fuzz)
just fuzz 10            # Run all fuzz targets for 10s each
```

Direct cargo commands:
```bash
cargo test --test config        # Run a single integration test file
cargo test --test config -- test_name  # Run a specific test
cargo test --lib                # Unit tests only
cargo test --features ffi       # Include FFI tests
```

## Architecture

**Single crate** with feature-gated modules — not a workspace of multiple crates (the README's architecture diagram is outdated).

### Feature flags
- `default = ["cli"]` — enables CLI binary and interactive shell (clap, rustyline)
- `ffi` — enables C-ABI bindings in `src/ffi.rs`; conditionally allows `unsafe_code` via `cfg_attr`
- `hyprland` — enables Hyprland IPC integration in `src/hyprland/`; conditionally allows `unsafe_code` via `cfg_attr`

### Core modules (always available)
- **`logger/`** — `Logger` struct with builder pattern. Holds a `Vec<Box<dyn Output>>` and dispatches `LogRecord` to each output. Sub-modules: `builder.rs` (TerminalBuilder, FileBuilder), `json_builder.rs`, `from_config.rs`.
- **`output/`** — `trait Output: Send + Sync` with `write(&LogRecord)` and `flush()`. Three backends: `TerminalOutput`, `FileOutput`, `JsonOutput`.
- **`config/`** — TOML deserialization with Hyprland-style `source = "path"` inclusion and cyclic detection. Per-app overrides via `[apps.APP_NAME]`. Structs in `structs.rs`.
- **`fmt/`** — Formatting subsystem: `color.rs` (hex parsing), `tag.rs` (prefix/suffix/transform/alignment), `scope.rs`, `style.rs` (inline XML-like `<bold>`, `<red>` tags), `icon.rs` (NerdFont/ASCII/none), `highlight.rs` (regex-based auto-highlighting), `format.rs` (template placeholders like `{tag} {scope} {msg}`).
- **`level/`** — Log levels: Trace, Debug, Info, Warn, Error. Implements `Ord` for filtering.
- **`cleanup/`** — Age/size-based log cleanup with gzip compression support.
- **`internal/`** — Internal logger for hyprlog itself (uses `OnceLock`).

### Feature-gated modules
- **`cli/`** (feature: `cli`) — Clap-based subcommands in `cli/commands/`: log, json, preset, stats, cleanup, themes.
- **`shell/`** (feature: `cli`) — Interactive REPL using rustyline with built-in themes.
- **`hyprland/`** (feature: `hyprland`) — Hyprland IPC via Unix domain sockets. Socket1 (commands), Socket2 (events). Event parsing, level mapping, signal handling.
- **`ffi.rs`** (feature: `ffi`) — C-ABI FFI via `HyprlogContext` opaque pointer. Header generated by cbindgen (`cbindgen.toml`). C++ example in `examples/cpp/`.

### Key patterns
- Builder pattern: `Logger::builder().level(Level::Debug).terminal().colors(true).done().build()`
- All outputs implement `trait Output` — extend by adding a new backend
- Config merging: multiple `source = "..."` lines pull in additional TOML files before parsing
- `LogRecord.raw` flag bypasses all formatting (tag, icon, scope)
- `Logger::print()` bypasses level filtering for command output

## Lints

Cargo.toml enables `clippy::all`, `clippy::pedantic`, and `clippy::nursery` as warnings. The `--strict` lint mode treats these as errors. Keep code clean against these lints.

## Testing

Integration tests are in `tests/` (23 files). Tests use `tempfile` for filesystem operations. No CI/CD is configured — tests run locally via `just test`.

## Benchmarks

Criterion benchmarks in `benches/` (3 files): `parsing.rs`, `formatting.rs`, `output.rs`. Run with `just bench` or `cargo bench`. Reports at `target/criterion/report/index.html`.

## Fuzz Testing

Fuzz tests in `fuzz/` (standalone workspace crate, 6 targets). Requires `cargo-fuzz` (`cargo install cargo-fuzz`) and nightly toolchain. Run with `just fuzz` or individual targets via `cargo fuzz run <target> -- -max_total_time=30`.
